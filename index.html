<!DOCTYPE HTML>
<html>
  <head>
		<script src="http:////ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>	
		<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>
		<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/ui-lightness/jquery-ui.css" rel="stylesheet" type="text/css">
    <style>
      body {
        margin: 0px;
        padding: 0px;
				background-color: #fff;
      }
      #myCanvas {
				opacity: 0.8;
				margin: 0px;
				z-index: 1;
      }
			#controls {
				padding: 10px;
				border: 1px solid #000;
				float: left;
				position:fixed;
				background-color: #fff;
				width: 250px;
				z-index: 99;
				opacity: 0.3;
			}
			#controls.hover {
				opacity: 1;
				background-color: rgba(255,255,255,0.95);
			}
			#slider {
				margin: 5px;
			}
			button {
				font-size: 0.8em;
				width: 80px;
			}
			#generations {
				margin-top: 10px;
				text-align: center;
			}			
    </style>
	</head>
	<body>
    <script>
      $(document).ready(function() {
				// Get the canvas and 2d context
        var canvas = document.getElementById('myCanvas');
        var context = canvas.getContext('2d');

				// Set some defaults
				var running = true;
				var interval = 250;
				var interval_id;
				var initial_fill = 0.25;
				var generationCount = 0;

				// Set the y-dimension to 40 cells, then use
				// the window width to calculate number of x-cells
				// The goal here is to end up with square cells.
				var cells_y = 40;
				canvas.width = window.innerWidth - 8;
        canvas.height = window.innerHeight - 8;
				var cell_height = parseInt($(canvas).height() / cells_y);
				var cell_width = cell_height;
				var cells_x = parseInt($(canvas).width() / cell_width);

				// Setup 2d array and fill according to the fill
				// we set above.
				boardGrid = fillGrid();

				// Draw the initial grid
				drawGrid(boardGrid.slice());

				// Start the timer to triger the game of life
				interval_id = setInterval(function(){ run() }, interval);

				// Bind the slider
				$("#slider").slider({
					min: 0,
					max: 1450,
					value: 1250,
					change: function(event, ui){
						clearInterval(interval_id);
						interval = 1500 - ui.value;
						if(running){
							interval_id = setInterval(function(){ run() }, interval);
						}
					}
				});

				// Bind the buttons
				$("button").button();
				$("#resetButton").click(function(event){ generationCount = 0; boardGrid = fillGrid(); drawGrid(boardGrid.slice());});
				$("#pauseButton").click(function(event){ 
					if(running){
						clearInterval(interval_id);
						$(this).text("Run");
					}
					else {
						interval_id = setInterval(function(){ run() }, interval);
						$(this).text("Pause");
					}
					running = !running;
				});
				$("#nextButton").click(function(event){ runOnce(); });

				// Make the controls more visible when hovered
				$("#controls").hover(
					// Hover In
					function(event){
						$(this).addClass("hover");
					},
					// Hover Out
					function(event){
						$(this).removeClass("hover");
					}
				);

				function run(){
					if(running){
  					boardGrid = nextGeneration(boardGrid.slice());
	  				drawGrid(boardGrid.slice());
					}
				}

				function runOnce(){
					boardGrid = nextGeneration(boardGrid.slice());
  				drawGrid(boardGrid.slice());
				}

				function fillGrid(){
  				var boardGrid = new Array(cells_x);
    			for(var i = 0; i < cells_x; i++){
  					boardGrid[i] = new Array(cells_y);
    				for(var j = 0; j < cells_y; j++){
  						if(Math.random() > (1 - initial_fill)){
  							boardGrid[i][j] = 1;
  						}
  						else {
  							boardGrid[i][j] = 0;
  						}
  					}
  				}
	  			return boardGrid.slice();
				}

				// Calculate the next generation and return
				// 2d array.
				function nextGeneration(boardGrid){
				  var newGrid = new Array(cells_x);
    			for(var i = 0; i < cells_x; i++){
  					newGrid[i] = new Array(cells_y);
    				for(var j = 0; j < cells_y; j++){
  						if(stayAlive(i,j, boardGrid)){
								newGrid[i][j] = boardGrid[i][j] + 1;	
							}
							else {
								newGrid[i][j] = 0;
							}
  					}
  				}
					generationCount++;
					$("#generationCount").text(generationCount);
					return newGrid.slice();
				}

				// Check a cell's neighbors to see if it should stay
				// alive. Fewer than two living neighbors and a cell
				// dies from lonliness, more than three and it dies
				// of overcrowding. A dead cell with exactly three
				// neighbors is revived.
				function stayAlive(x, y){
					var neighbors = 0;
					
					if(x > 0 && y > 0 &&boardGrid[x-1][y-1] > 0) {
						neighbors++;
					}
					if(y > 0 &&boardGrid[x][y-1] > 0) {
						neighbors++;
					}
					if(x < cells_x - 1 && y > 0 && boardGrid[x+1][y-1] > 0) {
						neighbors++;
					}
					if(x > 0 && boardGrid[x-1][y] > 0) {
						neighbors++;
					}
					if(x < cells_x - 1 && boardGrid[x+1][y] > 0) {
						neighbors++;
					}
					if(x > 0 && y < cells_y - 1 && boardGrid[x-1][y+1] > 0) {
						neighbors++;
					}
					if(y < cells_y - 1 && boardGrid[x][y+1] > 0) {
						neighbors++;
					}
					if(x < cells_x - 1 && y < cells_y - 1 && boardGrid[x+1][y+1] > 0) {
						neighbors++;
					}
  				if ((boardGrid[x][y] > 0 && (neighbors == 2 || neighbors == 3)) || (boardGrid[x][y] == 0 && neighbors == 3)){
						return true;
					}
					return false;
				}

				// Draw the grid. Fairly self-explanatory.
				function drawGrid(boardGrid){
    			for(var i = 0; i < cells_x; i++){
    				for(var j = 0; j < cells_y; j++){
  					  if (boardGrid[i][j] > 0){
								drawCell(i,j,boardGrid[i][j]);
  						}
	  					else if(boardGrid[i][j] == 0){
								clearCell(i,j);
  						}						
    				}
    			}
				}

				// Draw a giving cell, also self-explanatory.
				// First generation cells are grey, if they
				// live for a second generation they're blue.
				// Third is green and fourth is red.
				function drawCell(x, y, count) {
					var color;
					if(count == 1){
	 					color = "rgba(128,128,128,1)";
					}
					else if (count == 2){
	 					color = "blue";
					}
					else if (count == 3){
	 					color = "green";
					}
					else {
	 					color = "red";
					}
					context.beginPath();
					context.fillStyle = color;
					context.strokeStyle = color;
					context.lineWidth   = 2;
 					context.strokeRect(x * cell_width + 1, y * cell_height + 1, cell_width - 2, cell_height - 2);
 				  context.fillRect(x * cell_width + 4, y * cell_height + 4 , cell_width - 8, cell_height - 8);
				}

				// Used to clear the canvas when a cell dies
				function clearCell(x, y) {
 					context.clearRect(x * cell_width, y * cell_height, cell_width, cell_height, false);
				}
      });
    </script>
		<div id="controls">
			<div id="interval">
				<div>Generation Speed</div>
				<div id="slider"></div>
				<button id="pauseButton">Pause</button>
				<button id="nextButton">Next</button>
				<button id="resetButton">Reset</button>
				<div id="generations">Generations: <span id="generationCount"></span></div>
			</div>
		</div>
    <canvas id="myCanvas"></canvas>
  </body>
</html>

